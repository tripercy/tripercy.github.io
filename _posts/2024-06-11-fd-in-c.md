---
layout: post
title: "C/C++ file descriptor: khÃ´ng chá»‰ lÃ  Ä‘á»c ghi file"
date: 2024-06-11 09:57 +0700
author: tripercy
categories: [VI, C/C++]
tags: [C/C++, sharing]
---

Vá» Ä‘á»‹nh nghÄ©a: file descriptor lÃ  má»™t sá»‘ nguyÃªn khÃ´ng Ã¢m Ä‘Æ°á»£c sá»­ dá»¥ng trong má»™t tiáº¿n trÃ¬nh Ä‘ang thá»±c thi Ä‘á»ƒ xÃ¡c Ä‘á»‹nh má»™t file Ä‘ang Ä‘Æ°á»£c má»Ÿ.

Báº¥t ká»³ má»™t chÆ°Æ¡ng trÃ¬nh C/C++ nÃ o vá»›i cÃ¡c chá»©c nÄƒng tÆ°Æ¡ng tÃ¡c vá»›i ngÆ°á»i dÃ¹ng qua terminal cÅ©ng sá»­ dá»¥ng Ã­t nháº¥t 3 file descriptor: stdin, stdout vÃ  stderr. Vá»›i nhá»¯ng ngÆ°á»i má»›i báº¯t Ä‘áº§u sá»­ dá»¥ng C/C++, cÃ¡c thao tÃ¡c input/output(io) Ä‘Æ°á»£c trá»«u tÆ°á»£ng hÃ³a qua cÃ¡c thÆ° viá»‡n vÃ  hÃ m xÃ¢y dá»±ng trÃªn file descriptor nhÆ° C vá»›i `printf`, `scanf`, `perror` hay C++ std vá»›i `cin`, `cout`, `cerr` vÃ  thÆ°á»ng sáº½ khÃ´ng cáº§n pháº£i quan tÃ¢m Ä‘áº¿n file descriptor.

Äi sÃ¢u hÆ¡n má»™t chÃºt, khi báº¯t Ä‘áº§u há»c cÃ¡ch xá»­ lÃ½ file trong C, ta cÃ³ thá»ƒ báº¯t gáº·p cÃ¡c hÃ m nhÆ° `open`, `read`, `write`, `close` Ä‘á»ƒ thao tÃ¡c vá»›i file, ta nháº­n tháº¥y cÃ¡c hÃ m nÃ y thao tÃ¡c vá»›i má»™t biáº¿n kiá»ƒu `int` mÃ  cÃ¡c tÃ i liá»‡u gá»i lÃ  "file descriptor". Máº·c dÃ¹ khÃ´ng cáº§n tÃ¬m hiá»ƒu, ta cÅ©ng cÃ³ thá»ƒ hÃ¬nh dung ra Ä‘á»‹nh nghÄ©a: file descriptor lÃ  má»™t con sá»‘ mÃ  chÆ°Æ¡ng trÃ¬nh sá»­ dá»¥ng Ä‘á»ƒ xÃ¡c Ä‘á»‹nh file mÃ  nÃ³ Ä‘ang thao tÃ¡c.

Tuy nhiÃªn, file descriptor khÃ´ng chá»‰ Ä‘Æ¡n giáº£n lÃ  váº­y. Trong quÃ¡ trÃ¬nh phÃ¡t triá»ƒn ká»¹ nÄƒng láº­p trÃ¬nh C, ta sáº½ nháº­n tháº¥y sá»± xuáº¥t hiá»‡n cá»§a file descriptor trong cÃ¡c ngá»¯ cáº£nh khÃ´ng liÃªn quan Ä‘áº¿n file vÃ  cÃ¡c thao tÃ¡c vá»›i file. Trong bÃ i viáº¿t nÃ y, mÃ¬nh sáº½ tÃ¬m hiá»ƒu cÃ¡ch hoáº¡t Ä‘á»™ng cá»§a file descriptor, cÃ¡c cÃ¡ch sá»­ dá»¥ng file descriptor vÃ  cÃ¡c chá»©c nÄƒng cá»§a file descriptor.

## Everything is a file

Há»‡ thá»‘ng file cá»§a Unix váº­n hÃ nh trÃªn Ã½ tÆ°á»Ÿng "Everything is a file" hay "Má»i thá»© Ä‘á»u lÃ  file". NghÄ©a lÃ , háº§u nhÆ° táº¥t cáº£ má»i thá»© Ä‘Æ°á»£c quáº£n lÃ½ dÆ°á»›i dáº¡ng má»™t file: tá»« cÃ¡c file thá»±c sá»± trÃªn á»• cá»©ng, cÃ¡c thiáº¿t bá»‹ nhÆ° á»• Ä‘Ä©a, bÃ n phÃ­m, chuá»™t, mÃ n hÃ¬nh, Ä‘áº¿n cÃ¡c káº¿t ná»‘i máº¡ng, socket, pipe, shared memory,... Ã tÆ°á»Ÿng nÃ y giáº£i thÃ­ch sá»± xuáº¥t hiá»‡n cá»§a file descriptor trong cÃ¡c ngá»¯ cáº£nh khÃ´ng liÃªn quan Ä‘áº¿n file nhÆ° láº­p trÃ¬nh socket hay pipe: trong Unix, má»i thá»© Ä‘á»u Ä‘Æ°á»£c xem nhÆ° má»™t file, vÃ  má»™t file cÃ³ thá»ƒ Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh trong chÆ°Æ¡ng trÃ¬nh báº±ng file descriptor.

## CÃ¡ch file descriptor hoáº¡t Ä‘á»™ng

VÃ¬ file descriptor lÃ  má»™t sá»‘ nguyÃªn khÃ´ng Ã¢m, ta cÃ³ thá»ƒ biÃªn dá»‹ch vÃ  cháº¡y thá»­ chÆ°Æ¡ng trÃ¬nh C dÆ°á»›i Ä‘Ã¢y:

> HÃ£y táº¡o 3 file `file1`, `file2`, `file3` vÃ  Ä‘áº·t cÃ¡c file nÃ y vÃ o cÃ¹ng directory vá»›i chÆ°Æ¡ng trÃ¬nh trÆ°á»›c khi thá»±c hiá»‡n. 
{: .prompt-info}

```c
#include <fcntl.h>
#include <stdio.h>
#include <unistd.h>

int main(int argc, char const *argv[]) {
    // Má»Ÿ file 1
    int fd1 = open("file1", O_RDONLY);
    if (fd1 == -1) {
        perror("Error opening file1\n");
        return 1;
    }

    // Má»Ÿ file 2
    int fd2 = open("file2", O_RDONLY);
    if (fd2 == -1) {
        perror("Error opening file2\n");
        return 1;
    }

    printf("Fd for file1: %d\n", fd1);
    printf("Fd for file2: %d\n", fd2);

    // ÄÃ³ng file 1
    printf("Closing file1\n");
    close(fd1);
    
    // Má»Ÿ file 3
    int fd3 = open("file3", O_RDONLY);
    if (fd3 == -1) {
        perror("Error opening file3\n");
        return 1;
    }

    printf("Fd for file3: %d\n", fd3);
    close(fd2);
    close(fd3);

    return 0;
}
```

Sau khi cháº¡y chÆ°Æ¡ng trÃ¬nh, ta sáº½ tháº¥y káº¿t quáº£ nhÆ° sau:

```
Fd for file1: 3
Fd for file2: 4
Closing file1
Fd for file3: 3
```

Tá»« output cá»§a vÃ­ dá»¥ trÃªn, ta cÃ³ thá»ƒ Ä‘Æ°a ra 2 nháº­n xÃ©t:
- CÃ¡c file descriptor Ä‘Æ°á»£c má»Ÿ liÃªn tiáº¿p cÃ³ giÃ¡ trá»‹ tÄƒng dáº§n.
- Sau khi Ä‘Ã³ng file1 vÃ  má»Ÿ file3, file descriptor cho file3 cÃ³ giÃ¡ trá»‹ báº±ng vá»›i file descriptor Ä‘Ã£ Ä‘Æ°á»£c Ä‘Ã³ng.

### File descriptor table

Tá»« 2 nháº­n xÃ©t trÃªn, ta nháº­n tháº¥y file descriptor khÃ´ng pháº£i Ä‘Æ°á»£c táº¡o ra má»™t cÃ¡ch ngáº«u nhiÃªn mÃ  Ä‘Æ°á»£c táº¡o ra theo má»™t quy luáº­t nÃ o Ä‘Ã³. Láº­t láº¡i pháº§n má»Ÿ Ä‘áº§u, mÃ¬nh Ä‘Ã£ giá»›i thiá»‡u ráº±ng má»—i chÆ°Æ¡ng trÃ¬nh Ä‘á»u máº·c Ä‘á»‹nh sá»Ÿ há»¯u 3 file descriptor: stdin, stdout vÃ  stderr. VÃ  tá»« output vÃ­ dá»¥, cÃ¡c file descriptor Ä‘Æ°á»£c táº¡o ra cÃ³ giÃ¡ trá»‹ báº¯t Ä‘áº§u tá»« 3. Nhá»› ráº±ng, (háº§u háº¿t) táº¥t cáº£ cÃ¡c bá»™ Ä‘áº¿m trong láº­p trÃ¬nh máº·c Ä‘á»‹nh báº¯t Ä‘áº§u tá»« 0, vÃ  3 vá»‹ trÃ­ Ä‘áº§u (0, 1, 2) cÃ³ váº» Ä‘Ã£ Ä‘Æ°á»£c dÃ nh cho stdin, stdout vÃ  stderr. Váº­y nghÄ©a lÃ  háº³n pháº£i cÃ³ má»™t cáº¥u trÃºc dá»¯ liá»‡u nÃ o Ä‘Ã³ lÆ°u trá»¯ thÃ´ng tin vá» file descriptor vÃ  táº¡o ra file descriptor má»›i dá»±a trÃªn cÃ¡c file descriptor Ä‘Ã£ Ä‘Æ°á»£c táº¡o ra trÆ°á»›c Ä‘Ã³.

Cáº¥u trÃºc dá»¯ liá»‡u nÃ y Ä‘Æ°á»£c gá»i lÃ  File descriptor table. Má»™t cÃ¡ch Ä‘Æ¡n giáº£n, Ä‘Ã¢y lÃ  má»™t máº£ng cÃ¡c sá»‘ nguyÃªn khÃ´ng Ã¢m liÃªn tiáº¿p, má»—i pháº§n tá»­ trong máº£ng lÃ  má»™t file descriptor. Khi ta táº¡o ra má»™t file descriptor má»›i, há»‡ thá»‘ng sáº½ tÃ¬m vá»‹ trÃ­ Ä‘áº§u tiÃªn trong máº£ng chÆ°a Ä‘Æ°á»£c sá»­ dá»¥ng vÃ  gÃ¡n giÃ¡ trá»‹ cho file descriptor má»›i. Khi ta Ä‘Ã³ng má»™t file descriptor, vá»‹ trÃ­ tÆ°Æ¡ng á»©ng trong máº£ng sáº½ Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u lÃ  chÆ°a Ä‘Æ°á»£c sá»­ dá»¥ng vÃ  cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng cho file descriptor Ä‘Æ°á»£c táº¡o ra sau nÃ y.

> Äá»™ rá»™ng cá»§a file descriptor table lÃ  cá»‘ Ä‘á»‹nh vÃ  Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh bá»Ÿi há»‡ thá»‘ng. Trong háº§u háº¿t cÃ¡c há»‡ Ä‘iá»u hÃ nh hiá»‡n Ä‘áº¡i, Ä‘á»™ rá»™ng nÃ y thÆ°á»ng lÃ  1024 hoáº·c 4096 vÃ  cÃ³ thá»ƒ Ä‘Æ°á»£c kiá»ƒm tra báº±ng cÃ¡ch cháº¡y cÃ¢u lá»‡nh `ulimit -n` trÃªn terminal. 
{: .prompt-info}

### Open file table vÃ  Inode table

Viá»‡c má»Ÿ má»™t file trong nhiá»u chÆ°Æ¡ng trÃ¬nh lÃ  má»™t tÃ­nh nÄƒng cáº§n thiáº¿t. Tuy nhiÃªn, Ä‘á»ƒ cho phÃ©p tÃ­nh nÄƒng nÃ y hoáº¡t Ä‘á»™ng, há»‡ Ä‘iá»u hÃ nh cáº§n pháº£i quáº£n lÃ½ cÃ¡c file Ä‘Æ°á»£c má»Ÿ nÃ y nháº±m kiá»ƒm soÃ¡t viá»‡c truy cáº­p vÃ  thay Ä‘á»•i dá»¯ liá»‡u cá»§a file. Trong Unix, má»—i file Ä‘Æ°á»£c má»Ÿ sáº½ Ä‘Æ°á»£c quáº£n lÃ½ thÃ´ng qua má»™t cáº¥u trÃºc dá»¯ liá»‡u gá»i lÃ  Open file table. Open file table Ä‘Æ°á»£c chia sáº» giá»¯a táº¥t cáº£ cÃ¡c tiáº¿n trÃ¬nh vÃ  má»—i láº§n má»™t file Ä‘Æ°á»£c má»Ÿ, má»™t entry má»›i sáº½ Ä‘Æ°á»£c táº¡o ra trong Open file table. Váº­y cÃ³ nghÄ© lÃ , má»—i láº§n ta muá»‘n táº¡o má»™t file descriptor, há»‡ thá»‘ng sáº½ táº¡o má»™t entry má»›i trong Open file table vÃ  gÃ¡n file descriptor cho entry nÃ y.

Tuy nhiÃªn, cÃ¡c entry trong Open file table khÃ´ng chá»©a vá»‹ trÃ­ cá»§a file mÃ  chá»‰ chá»©a metadata cá»§a file trong láº§n má»Ÿ Ä‘Ã³, vÃ­ dá»¥ nhÆ° vá»‹ trÃ­ con trá» Ä‘á»c/ghi, quyá»n truy cáº­p, tráº¡ng thÃ¡i file,... Dá»¯ liá»‡u thá»±c sá»± vá» thÃ´ng tin file Ä‘Æ°á»£c lÆ°u trá»¯ trong má»™t cáº¥u trÃºc dá»¯ liá»‡u khÃ¡c gá»i lÃ  Inode table. Má»—i file trÃªn há»‡ thá»‘ng Unix sáº½ cÃ³ má»™t entry trong Inode table, vÃ  má»—i entry nÃ y sáº½ chá»©a thÃ´ng tin vá» file nhÆ° kÃ­ch thÆ°á»›c, quyá»n truy cáº­p, vá»‹ trÃ­ lÆ°u trá»¯ trÃªn á»• cá»©ng,...

> Báº¡n cÃ³ thá»ƒ theo dÃµi cÃ¡c entry cá»§a inode table trong folder hiá»‡n táº¡i báº±ng cÃ¡ch cháº¡y cÃ¢u lá»‡nh `ls -i` trÃªn terminal. Con sá»‘ Ä‘á»©ng trÆ°á»›c tÃªn file chÃ­nh lÃ  index cá»§a file trong inode table.
{: .prompt-info}

### TL;DR

![File descriptor structure](https://upload.wikimedia.org/wikipedia/commons/f/f8/File_table_and_inode_table.svg)
_CÃ¡ch file descriptor map Ä‘áº¿n file (Nguá»“n: [wikimedia](https://commons.wikimedia.org/w/index.php?curid=38970813))_

- File descriptor lÃ  má»™t sá»‘ nguyÃªn khÃ´ng Ã¢m Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ xÃ¡c Ä‘á»‹nh file Ä‘ang Ä‘Æ°á»£c má»Ÿ.
- File descriptor khÃ´ng trá»±c tiáº¿p map Ä‘áº¿n file mÃ  táº¡o ra vÃ  map Ä‘áº¿n má»™t entry trong Open file table.
- Má»™t entry trong Open file table chá»©a metadata liÃªn quan Ä‘áº¿n viá»‡c Ä‘á»c ghi file.
- Má»™t entry trong Open file table map Ä‘áº¿n má»™t entry trong Inode table.
- CÃ³ thá»ƒ cÃ³ nhiá»u entry cá»§a Open file table map Ä‘áº¿n má»™t entry cá»§a Inode table.
- Má»™t entry cá»§a Inode table chá»©a thÃ´ng tin thá»±c sá»± vá» file nhÆ° kÃ­ch thÆ°á»›c, quyá»n truy cáº­p, vá»‹ trÃ­ lÆ°u trá»¯ trÃªn á»• cá»©ng,...

## TÆ°Æ¡ng tÃ¡c vá»›i file descriptor

Trong má»¥c nÃ y, mÃ¬nh sáº½ giá»›i thiá»‡u vá» nhá»¯ng hÃ m mÃ  mÃ¬nh tháº¥y thÆ°á»ng Ä‘Æ°á»£c xá»­ dá»¥ng khi lÃ m viá»‡c vá»›i file descriptor. Äá»“ng thá»i cÅ©ng sáº½ nÃ³i thÃªm vá» cÃ¡c tÆ°Æ¡ng tÃ¡c vá»›i file descriptor trong má»™t sá»‘ trÆ°á»ng há»£p.

### Táº¡o file descriptor

> File descriptor lÃ  má»™t sá»‘ nguyÃªn khÃ´ng Ã¢m, vÃ¬ váº­y, náº¿u má»™t file descriptor khÃ´ng thá»ƒ Ä‘Æ°á»£c táº¡o ra, hÃ m táº¡o file descriptor sáº½ tráº£ vá» -1. Ta nÃªn táº¡o thÃ³i quen kiá»ƒm tra giÃ¡ trá»‹ tráº£ vá» cá»§a hÃ m táº¡o file descriptor trÆ°á»›c khi sá»­ dá»¥ng file descriptor Ä‘Ã³ Ä‘á»ƒ trÃ¡nh cÃ¡c lá»—i khÃ´ng mong muá»‘n.
{: .prompt-warning}

#### open

HÃ m `open` Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong thÆ° viá»‡n `<fcntl.h>` Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ má»Ÿ má»™t file vÃ  tráº£ vá» má»™t file descriptor cá»§a file vá»«a Ä‘Æ°á»£c má»Ÿ:
```c
int open(const char *pathname, int flags);
```
vá»›i flags lÃ  má»™t sá»‘ nguyÃªn biá»ƒu diá»…n cÃ¡ch má»Ÿ file. CÃ¡c macro Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a cho flags:
- `O_RDONLY`: Má»Ÿ file chá»‰ Ä‘á»ƒ Ä‘á»c.
- `O_WRONLY`: Má»Ÿ file chá»‰ Ä‘á»ƒ ghi.
- `O_RDWR`: Má»Ÿ file Ä‘á»ƒ Ä‘á»c vÃ  ghi.
- `O_CREAT`: Táº¡o file náº¿u file khÃ´ng tá»“n táº¡i.
- `O_TRUNC`: XÃ³a ná»™i dung file náº¿u file Ä‘Ã£ tá»“n táº¡i.
- `O_APPEND`: Ghi vÃ o cuá»‘i file.

#### creat

CÅ©ng Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong `<fcntl.h>`, `creat` hoáº¡t Ä‘á»™ng tÆ°Æ¡ng tá»± nhÆ° `open` vá»›i flags lÃ  `O_WRONLY | O_CREAT | O_TRUNC`. 

#### socket vÃ  accept

Trong láº­p trÃ¬nh socket, ta cÅ©ng sá»­ dá»¥ng file descriptor Ä‘á»ƒ xÃ¡c Ä‘á»‹nh socket vÃ  káº¿t ná»‘i. HÃ m `socket` vÃ  `accept` Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong thÆ° viá»‡n `<sys/socket.h>`:
```c
int socket(int domain, int type, int protocol);
int accept(int sockfd, struct sockaddr *addr, socklen_t *addrlen);
```
CÃ¡c tham sá»‘ cá»§a 2 hÃ m nÃ y khÃ¡ phá»©c táº¡p vÃ  náº±m ngoÃ i pháº¡m vi bÃ i viáº¿t nÃ y nÃªn mÃ¬nh sáº½ táº¡m thá»i bá» qua. Má»™t cÃ¡ch tá»•ng quÃ¡t, 2 hÃ m nÃ y Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ táº¡o ra má»™t socket vÃ  cháº¥p nháº­n káº¿t ná»‘i tá»« má»™t socket khÃ¡c, vÃ  nhÆ° Ä‘Ã£ giáº£i thÃ­ch, trong Unix, socket cÅ©ng Ä‘Æ°á»£c xem nhÆ° má»™t file nÃªn sáº½ cÃ³ má»™t file descriptor tÆ°Æ¡ng á»©ng Ä‘Æ°á»£c táº¡o ra.

#### pipe

HÃ m `pipe` Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong `<unistd.h>` vÃ  Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ táº¡o ra má»™t pipe giá»¯a 2 tiáº¿n trÃ¬nh:
```c
int pipe(int pipefd[2]);
```
vá»›i `pipefd` lÃ  má»™t máº£ng 2 pháº§n tá»­ chá»©a file descriptor cá»§a 2 Ä‘áº§u cá»§a pipe. Má»™t Ä‘áº§u cá»§a pipe sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ ghi vÃ  má»™t Ä‘áº§u sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ Ä‘á»c.

### ÄÃ³ng file descriptor

NhÆ° Ä‘Ã£ Ä‘á» cáº­p, sá»‘ lÆ°á»£ng entry cá»§a File descriptor table lÃ  cá»‘ Ä‘á»‹nh vÃ  há»‡ thá»‘ng sáº½ khÃ´ng táº¡o ra thÃªm file descriptor náº¿u Ä‘Ã£ Ä‘áº¡t Ä‘áº¿n giá»›i háº¡n. VÃ¬ váº­y, ta nÃªn táº¡o thÃ³i quen Ä‘Ã³ng file descriptor sau khi khÃ´ng cáº§n sá»­ dá»¥ng ná»¯a. Äá»ƒ Ä‘Ã³ng file descriptor, ta sá»­ dá»¥ng hÃ m `close` trong thÆ° viá»‡n `<unistd.h>`:
```c
int close(int fd);
```
vá»›i `fd` lÃ  file descriptor cáº§n Ä‘Ã³ng. HÃ m close Ä‘á»“ng thá»i tráº£ vá» má»™t sá»‘ nguyÃªn biá»ƒu diá»…n káº¿t quáº£ cá»§a viá»‡c Ä‘Ã³ng file descriptor. Náº¿u Ä‘Ã³ng thÃ nh cÃ´ng, hÃ m tráº£ vá» 0, ngÆ°á»£c láº¡i tráº£ vá» -1.

### TÆ°Æ¡ng tÃ¡c vá»›i file descriptor

#### read vÃ  write

HÃ m `read` vÃ  `write` Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong thÆ° viá»‡n `<unistd.h>` vÃ  Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ Ä‘á»c vÃ  ghi dá»¯ liá»‡u vÃ o file descriptor:
```c
ssize_t read(int fd, void *buf, size_t count);
ssize_t write(int fd, const void *buf, size_t count);
```
vá»›i `fd` lÃ  file descriptor, `buf` lÃ  con trá» trá» Ä‘áº¿n vÃ¹ng nhá»› chá»©a dá»¯ liá»‡u cáº§n Ä‘á»c/ghi vÃ  `count` lÃ  sá»‘ byte cáº§n Ä‘á»c/ghi. HÃ m `read` vÃ  `write` tráº£ vá» sá»‘ byte Ä‘Ã£ Ä‘á»c/ghi hoáº·c -1 náº¿u gáº·p lá»—i.

Vá» cÆ¡ báº£n, hÃ m `read` vÃ  `write` hoáº¡t Ä‘á»™ng tÆ°Æ¡ng tá»± nhÆ° `fread` vÃ  `fwrite` trong thÆ° viá»‡n `stdio.h` nhÆ°ng khÃ´ng cÃ³ buffer nÃªn viá»‡c Ä‘á»c/ghi dá»¯ liá»‡u sáº½ Ä‘Æ°á»£c thá»±c hiá»‡n trá»±c tiáº¿p vÃ o file descriptor.

#### recv vÃ  send

Trong láº­p trÃ¬nh socket, ta cÅ©ng sá»­ dá»¥ng hÃ m `recv` vÃ  `send` Ä‘á»ƒ Ä‘á»c vÃ  ghi dá»¯ liá»‡u vÃ o cÃ¡c socket fd:
```c
ssize_t recv(int sockfd, void *buf, size_t len, int flags);
ssize_t send(int sockfd, const void *buf, size_t len, int flags);
```
vá»›i `sockfd` lÃ  socket file descriptor, `buf` lÃ  con trá» trá» Ä‘áº¿n vÃ¹ng nhá»› chá»©a dá»¯ liá»‡u cáº§n Ä‘á»c/ghi, `len` lÃ  sá»‘ byte cáº§n Ä‘á»c/ghi vÃ  `flags` lÃ  cÃ¡c cá» Ä‘iá»u khiá»ƒn. HÃ m `recv` vÃ  `send` cÅ©ng tráº£ vá» sá»‘ byte Ä‘Ã£ Ä‘á»c/ghi hoáº·c -1 náº¿u gáº·p lá»—i.

KhÃ¡c vá»›i `read` vÃ  `write`, `recv` vÃ  `send` cÃ²n cÃ³ thÃªm tham sá»‘ `flags` Ä‘á»ƒ Ä‘iá»u khiá»ƒn cÃ¡ch thá»©c Ä‘á»c/ghi dá»¯ liá»‡u tá»« socket.

#### lseek vÃ  llseek

HÃ m `lseek` vÃ  `llseek` Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ di chuyá»ƒn con trá» Ä‘á»c/ghi trong file descriptor:
```c
off_t lseek(int fd, off_t offset, int whence);
off64_t llseek(int fd, off64_t offset, unsigned int whence);
```

#### fstat

HÃ m `fstat` Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ láº¥y thÃ´ng tin vá» file descriptor:
```c
int fstat(int fd, struct stat *buf);
```
vá»›i `fd` lÃ  file descriptor vÃ  `buf` lÃ  con trá» trá» Ä‘áº¿n struct `stat` chá»©a thÃ´ng tin vá» file descriptor.

`fstat` láº¥y thÃ´ng tin tá»« Inode table thÃ´ng qua file descriptor vÃ  lÆ°u vÃ o struct `stat`. Struct `stat` chá»©a thÃ´ng tin nhÆ° kÃ­ch thÆ°á»›c file, quyá»n truy cáº­p,...

#### CÃ¡c tÆ°Æ¡ng tÃ¡c socket

Trong láº­p trÃ¬nh socket, ta cÃ²n sá»­ dá»¥ng cÃ¡c hÃ m nhÆ° `bind`, `listen`, `connect`, `accept`, `shutdown`,... Ä‘á»ƒ tÆ°Æ¡ng tÃ¡c vá»›i socket. CÃ¡c hÃ m nÃ y cÅ©ng sá»­ dá»¥ng file descriptor Ä‘á»ƒ xÃ¡c Ä‘á»‹nh socket vÃ  káº¿t ná»‘i.

#### mmap vÃ  munmap

HÃ m `mmap` vÃ  `munmap` Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ Ã¡nh xáº¡ má»™t file vÃ o bá»™ nhá»›:
```c
void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset);
int munmap(void *addr, size_t length);
```
vá»›i `addr` lÃ  Ä‘á»‹a chá»‰ báº¯t Ä‘áº§u cá»§a vÃ¹ng nhá»› Ä‘Æ°á»£c Ã¡nh xáº¡, `length` lÃ  kÃ­ch thÆ°á»›c vÃ¹ng nhá»› cáº§n Ã¡nh xáº¡, `prot` lÃ  quyá»n truy cáº­p, `flags` lÃ  cá» Ä‘iá»u khiá»ƒn, `fd` lÃ  file descriptor cá»§a file cáº§n Ã¡nh xáº¡ vÃ  `offset` lÃ  vá»‹ trÃ­ báº¯t Ä‘áº§u Ã¡nh xáº¡.

Viá»‡c Ã¡nh xáº¡ file vÃ o bá»™ nhá»› giÃºp ta truy cáº­p dá»¯ liá»‡u trong file má»™t cÃ¡ch hiá»‡u quáº£ hÆ¡n vÃ  cÅ©ng giÃºp giáº£m thiá»ƒu viá»‡c Ä‘á»c/ghi dá»¯ liá»‡u tá»« file descriptor.

CÃ¡c flags cá»§a hÃ m `mmap`:
- `MAP_SHARED`: Ãnh xáº¡ file vÃ o bá»™ nhá»› vÃ  cho phÃ©p cÃ¡c tiáº¿n trÃ¬nh khÃ¡c truy cáº­p.
- `MAP_PRIVATE`: Ãnh xáº¡ file vÃ o bá»™ nhá»› nhÆ°ng khÃ´ng cho phÃ©p cÃ¡c tiáº¿n trÃ¬nh khÃ¡c truy cáº­p.
- `MAP_ANONYMOUS`: Ãnh xáº¡ má»™t vÃ¹ng nhá»› khÃ´ng liÃªn káº¿t vá»›i file.

> TrÃªn má»™t sá»‘ há»‡ Ä‘iá»u hÃ nh, giÃ¡ trá»‹ cá»§a `offset` pháº£i lÃ  bá»™i sá»‘ cá»§a kÃ­ch thÆ°á»›c trang váº­t lÃ½ cá»§a há»‡ thá»‘ng. Äá»ƒ láº¥y kÃ­ch thÆ°á»›c trang váº­t lÃ½, ta cÃ³ thá»ƒ sá»­ dá»¥ng hÃ m `sysconf(_SC_PAGESIZE)`.
{: .prompt-warning}

### Quáº£n lÃ½ nhiá»u file descriptor má»™t lÃºc

Trong má»™t sá»‘ trÆ°á»ng há»£p, ta cáº§n quáº£n lÃ½ nhiá»u file descriptor má»™t lÃºc, vÃ­ dá»¥ nhÆ° khi má»™t server Ä‘á»£i nhiá»u káº¿t ná»‘i tá»« nhiá»u client khÃ¡c nhau. Trong trÆ°á»ng há»£p nÃ y, ta cáº§n sá»­ dá»¥ng hÃ m `select` hoáº·c `poll` Ä‘á»ƒ quáº£n lÃ½ nhiá»u file descriptor má»™t cÃ¡ch hiá»‡u quáº£.

#### select

HÃ m `select` Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ chá» Ä‘á»£i sá»± kiá»‡n xáº£y ra trÃªn má»™t hoáº·c nhiá»u file descriptor:
```c
int select(int nfds, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, struct timeval *timeout);
```
vá»›i `nfds` lÃ  sá»‘ lá»›n nháº¥t cá»§a file descriptor, `readfds`, `writefds`, `exceptfds` lÃ  cÃ¡c táº­p há»£p file descriptor cáº§n kiá»ƒm tra, `timeout` lÃ  thá»i gian chá» Ä‘á»£i.

HÃ m `select` sáº½ chá» Ä‘á»£i sá»± kiá»‡n xáº£y ra trÃªn cÃ¡c file descriptor trong `readfds`, `writefds`, `exceptfds` trong khoáº£ng thá»i gian `timeout`. Náº¿u cÃ³ sá»± kiá»‡n xáº£y ra, hÃ m tráº£ vá» sá»‘ file descriptor cÃ³ sá»± kiá»‡n xáº£y ra, ngÆ°á»£c láº¡i tráº£ vá» 0.

#### poll

HÃ m `poll` cÅ©ng Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ chá» Ä‘á»£i sá»± kiá»‡n xáº£y ra trÃªn má»™t hoáº·c nhiá»u file descriptor:
```c
int poll(struct pollfd *fds, nfds_t nfds, int timeout);
```
vá»›i `fds` lÃ  má»™t máº£ng cÃ¡c struct `pollfd` chá»©a thÃ´ng tin vá» file descriptor cáº§n kiá»ƒm tra, `nfds` lÃ  sá»‘ lá»›n nháº¥t cá»§a file descriptor, `timeout` lÃ  thá»i gian chá» Ä‘á»£i.

HÃ m `poll` hoáº¡t Ä‘á»™ng tÆ°Æ¡ng tá»± nhÆ° `select` nhÆ°ng cung cáº¥p cÃ¡ch tiáº¿p cáº­n linh hoáº¡t hÆ¡n vÃ  hiá»‡u quáº£ hÆ¡n.

## Káº¿t luáº­n

ThÃ´ng qua bÃ i viáº¿t nÃ y, mÃ¬nh Ä‘Ã£ giá»›i thiá»‡u vá» file descriptor, cÃ¡ch file descriptor hoáº¡t Ä‘á»™ng vÃ  cÃ¡c hÃ m thao tÃ¡c vá»›i file descriptor. File descriptor khÃ´ng chá»‰ Ä‘Æ¡n giáº£n lÃ  má»™t sá»‘ nguyÃªn dÃ¹ng Ä‘á»ƒ xÃ¡c Ä‘á»‹nh file mÃ  cÃ²n lÃ  má»™t cÃ¡ch tiáº¿p cáº­n Ä‘á»ƒ tÆ°Æ¡ng tÃ¡c linh hoáº¡t vá»›i nhiá»u loáº¡i file khÃ¡c nhau nhÆ° socket, pipe, shared memory,... 

Viá»‡c hiá»ƒu rÃµ vá» file descriptor sáº½ giÃºp ta hiá»ƒu rÃµ hÆ¡n vá» cÃ¡ch hoáº¡t Ä‘á»™ng cá»§a há»‡ thá»‘ng Unix vÃ  giÃºp ta táº­n dá»¥ng tá»‘i Ä‘a cÃ¡c tÃ­nh nÄƒng cá»§a há»‡ thá»‘ng, Ä‘á»“ng thá»i hiá»ƒu rÃµ hÆ¡n náº¿u gáº·p pháº£i cÃ¡c lá»—i liÃªn quan Ä‘áº¿n file descriptor.

That's it! Hy vá»ng má»i ngÆ°á»i tÃ¬m tháº¥y nhá»¯ng thÃ´ng tin há»¯u Ã­ch tá»« bÃ i viáº¿t nÃ y. Cáº£m Æ¡n má»i ngÆ°á»i Ä‘Ã£ Ä‘á»c Ä‘áº¿n Ä‘Ã¢y vÃ  háº¹n gáº·p láº¡i á»Ÿ nhá»¯ng bÃ i viáº¿t sau ğŸ¥º